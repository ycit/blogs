# MySQL

## InnoDB 锁

### 共享锁和排它锁

InnoDB 实现了标准的行级锁，有两种类型的行级锁：

- shared lock ， s 锁，即共享锁。共享锁允许持有该锁的事务读取一行数据
- exclusive lock，x锁，即排它锁。排它锁允许持有该锁的事务更新或者删除一行数据

事务 **T1** 在 r 行记录 上持有一个共享锁，如果事务 **T2** 在 r 行记录上同时请求一个共享锁，那么该请求可以立即通过，**T1** 和 **T2** 同时持有一个 s 锁；如果事务**T2** 在r 行记录上同时请求一个排它锁，那么这个请求是不会被通过。

事务**T1** 在 r行记录上持有一个排它锁，另外一个事务 **T2** 无论是请求 s 锁还是 x 锁，都不会被通过。



### 意向锁

InnoDB 支持多粒度锁定，即允许行锁 和 表锁并存。例如可以使用 lock table 语句在指定表上添加 排它锁(x 锁)。为了使多粒度级别锁可行，InnoDB 使用意向锁。意向锁是表级锁，用来表明事务稍后需要哪种类型的锁(共享锁或者排它锁)。有两种类型的意向锁：

- 意向共享锁(IS)：表示事务打算在表的单个行上设置共享锁。
- 意向排它锁(IX)：表示事务打算在表的单个行上设置排它锁。

例如， select ... Lock in share mode 设置了一个 IS 锁，select ... for update 设置了一个 IX 锁。

意向锁遵循如下协议：

- 事务在获取表中某行上的共享锁之前，它必须先获取表上的 IS 锁或更强的锁。
- 事务在获取表中某行上的排它锁之前，必须先获取表上的 IX 锁。

下表汇总了表级锁类型兼容性：

|      | `X`      | `IX`       | `S`        | `IS`       |
| ---- | -------- | ---------- | ---------- | ---------- |
| `X`  | Conflict | Conflict   | Conflict   | Conflict   |
| `IX` | Conflict | Compatible | Conflict   | Compatible |
| `S`  | Conflict | Conflict   | Compatible | Compatible |
| `IS` | Conflict | Compatible | Compatible | Compatible |

如果请求事务与现有锁兼容，则会将锁授予该事务，如果它与现有锁冲突，则不会授予该事务。事务将一直等到冲突的现有锁被释放。如果锁请求与现有锁冲突，并且由于由于导致死锁而无法授权，则会发生错误。

意向锁不会阻塞除了全表请求(例如，lock tables ... write)的其他任何请求。意向锁的主要目的是显示某人正在锁定一行，或者将要锁定表中的一行。

### 记录锁（record lock）

记录锁是在一条索引记录上的一个锁。例如，select c1 from t where c1=10 for update；用于防止任何其他事务插入，更新，或者删除 c1 为 10 的值的记录。

记录锁永远锁索引记录，即使表中没有定义索引。在这种情况下，innodb 会创建一个隐藏的聚集索引，并使用这个索引来锁定记录。

### 间隙锁（gap lock）

间隙锁是指索引记录之间的间隙上的锁，或在第一个或最后一个索引记录之前或者之后的间隙上的锁。例如，select c1 from t where c1 between 10 and 20 for update.阻止其他事务插入 c1 值为 15的列



### next-key lock

